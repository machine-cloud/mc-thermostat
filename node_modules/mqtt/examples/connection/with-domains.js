var mqtt = require('../..')
  , conn = mqtt.createConnection()
  , connDomain = require('domain').create();

// Add the connection to this domain
connDomain.add(conn);

// If we get an error, shut down the connection
connDomain.on('error', function(err) {
  conn.stream.end();
});

// When the socket connects...
conn.on('connected', function() {
  // Send a connect packet
  client.connect({
    clientId: 'testClient',
    keepalive: 3000,
    protocolId: 'MQIsdp',
    protocolVersion: 3
  });

  // Throw an error if we have connack problems
  client.on('connack', function(packet) {
    if (packet.returnCode === 0) {
      console.log('Connected');
    } else {
      throw new Error('Connection failed!');
    }
  });
});
